# Redirect HTTP to HTTPS
server {
  listen 80;
  server_name dev.i-guide.io;
  return 301 https://$host$request_uri;
}

map $http_user_agent $prerender_ua {
  "~*googlebot"                               1;
  "~*yahoo!\ slurp"                           1;
  "~*bingbot"                                 1;
  "~*yandex"                                  1;
  "~*baiduspider"                             1;
  "~*facebookexternalhit"                     1;
  "~*twitterbot"                              1;
  "~*rogerbot"                                1;
  "~*linkedinbot"                             1;
  "~*embedly"                                 1;
  "~*quora\ link\ preview"                    1;
  "~*showyoubot"                              1;
  "~*outbrain"                                1;
  "~*pinterest\/0\."                          1;
  "~*developers.google.com\/\+\/web\/snippet" 1;
  "~*slackbot"                                1;
  "~*vkshare"                                 1;
  "~*w3c_validator"                           1;
  "~*redditbot"                               1;
  "~*applebot"                                1;
  "~*whatsapp"                                1;
  "~*flipboard"                               1;
  "~*tumblr"                                  1;
  "~*bitlybot"                                1;
  "~*skypeuripreview"                         1;
  "~*nuzzel"                                  1;
  "~*discordbot"                              1;
  "~*google\ page\ speed"                     1;
  "~*qwantify"                                1;
  "~*pinterestbot"                            1;
  "~*bitrix\ link\ preview"                   1;
  "~*xing-contenttabreceiver"                 1;
  "~*chrome-lighthouse"                       1;
  "~*telegrambot"                             1;
  "~*google-inspectiontool"                   1;
  "~*petalbot"                                1;

  "~*teamsbot"            1;
  "~*msteams"             1;


  "~*guzzle"              1;
  "~*guzzlehttp"          1;
  "~*axios"               1;
  "~*python-requests"     1;
  "~*httpclient"          1;

  "~*Prerender" 0;
  default       0;
}

map $args $prerender_args {
  default $prerender_ua;
  "~(^|&)_escaped_fragment_=" 1;
}

map $http_x_prerender $x_prerender {
  default $prerender_args;
  "1"     0;
}

map $uri $prerender {
  default $x_prerender;
  "~*\.(js|css|xml|less|png|jpg|jpeg|gif|pdf|txt|ico|rss|zip|mp3|rar|exe|wmv|doc|avi|ppt|mpg|mpeg|tif|wav|mov|psd|ai|xls|mp4|m4a|swf|dat|dmg|iso|flv|m4v|torrent|ttf|woff|woff2|svg|eot)" 0;
}


# HTTPS server
server {
  listen 443 ssl;
	server_name dev.i-guide.io;

	ssl_certificate /etc/nginx/ssl/fullchain.pem;
	ssl_certificate_key /etc/nginx/ssl/privkey.pem;

	# Serve React frontend
	location / {
		root /usr/share/nginx/html;
		index index.html;

    if ($prerender = 1) {
      rewrite .* /prerenderio last;
    }

    try_files $uri $uri/ /index.html;



    # Disable caching for index.html
    # location = /index.html {
    #   add_header Cache-Control "no-cache, no-store, must-revalidate";
    #   add_header Pragma "no-cache";
    #   add_header Expires 0;

    #   if ($prerender = 1) {
    #     rewrite .* /prerenderio last;
    #   }

    #   try_files $uri $uri/ /index.html;
    # }

		include /etc/nginx/ip-list*.conf;
	}

	# Proxy API calls to the auth backend
	location /auth/ {
		# Proxy: auth container port 3000
    proxy_pass http://auth:3000/;
    proxy_http_version 1.1;

    # forward headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_redirect off;
  }

  location /prerenderio {
    internal;
    proxy_set_header  Host $host;
    proxy_set_header  X-Prerender-Int-Type Nginx;
    proxy_hide_header Cache-Control;
    add_header        Cache-Control "private,max-age=600,must-revalidate";
    resolver          127.0.0.11 valid=30s ipv6=off;
    proxy_pass        http://prerender:8000/render?url=https://iguide-prerender.cis220065.projects.jetstream-cloud.org$request_uri;
  }
}